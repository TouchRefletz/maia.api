name: Hash Computation Service

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: "URL of the file to download and hash"
        required: true
      slug:
        description: "Slug/Identifier for the request (used for Pusher channel)"
        required: true

jobs:
  compute-hash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download File
        run: |
          echo "Downloading file from: ${{ inputs.file_url }}"
          # Use a generic name 'temp_input.pdf' so the script path is predictable
          # Or preserve name if possible? Let's use 'temp_input.pdf' for simplicity.
          wget -O temp_input.pdf "${{ inputs.file_url }}"

          if [ ! -s temp_input.pdf ]; then
            echo "::error::File download failed or empty."
            exit 1
          fi

      - name: Compute Hash (Composite Action)
        id: compute
        uses: ./.github/actions/compute-hash
        with:
          path: "temp_input.pdf"

      # Removed 'Check for Hash Existence in Repository' step as this is now handled by the Worker/Frontend.

      - name: Notify Frontend (Pusher)
        if: always()
        env:
          PUSHER_APP_ID: ${{ secrets.PUSHER_APP_ID }}
          PUSHER_KEY: ${{ secrets.PUSHER_KEY }}
          PUSHER_SECRET: ${{ secrets.PUSHER_SECRET }}
          PUSHER_CLUSTER: ${{ secrets.PUSHER_CLUSTER }}
          CHANNEL: ${{ inputs.slug }}
          HASH: ${{ steps.compute.outputs.hash }}
          # Check Logic Removed: Always return false/null here. Worker handles deduplication.
          EXISTS: "false"
          FOUND_SLUG: ""
        run: |
          # Construct JSON payload
          # We send: { hash, exists, existing_slug }

          DATA_JSON=$(jq -n \
            --arg hash "$HASH" \
            --arg exists "$EXISTS" \
            --arg found_slug "$FOUND_SLUG" \
             '{hash: $hash, exists: ($exists == "true"), found_slug: $found_slug}'
          )

          # Construct Pusher Body
          BODY=$(jq -n \
            --arg name "hash_computed" \
            --arg channel "$CHANNEL" \
            --arg data "$DATA_JSON" \
            '{name: $name, channels: [$channel], data: $data}'
          )

          # Sign Request
          TS=$(date +%s)
          BODY_MD5=$(echo -n "$BODY" | md5sum | awk '{print $1}')
          SIGN_STRING="POST\n/apps/$PUSHER_APP_ID/events\nauth_key=$PUSHER_KEY&auth_timestamp=$TS&auth_version=1.0&body_md5=$BODY_MD5"
          AUTH_SIGNATURE=$(echo -n -e "$SIGN_STRING" | openssl dgst -sha256 -hmac "$PUSHER_SECRET" | sed 's/^.* //')

          echo "Broadcasting to Pusher Channel: $CHANNEL"

          curl -s -X POST "https://api-$PUSHER_CLUSTER.pusher.com/apps/$PUSHER_APP_ID/events?auth_key=$PUSHER_KEY&auth_timestamp=$TS&auth_version=1.0&body_md5=$BODY_MD5&auth_signature=$AUTH_SIGNATURE" \
            -H "Content-Type: application/json" \
            -d "$BODY"
