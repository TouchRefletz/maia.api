name: OpenHands Deep Search

on:
  workflow_dispatch:
    inputs:
      query:
        description: "Search Query"
        required: true
        default: "Pesquise na internet todas as provas da obmep 2023"

jobs:
  run-openhands:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Docker volume
        run: docker volume create oh-work

      - name: Remove existing container
        run: docker rm -f openhands-test 2>/dev/null || true

      - name: Run OpenHands
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          QUERY: ${{ inputs.query }}
        run: |
          docker run -i --pull=always \
            -u 0 \
            -e SANDBOX_USER_ID=0 \
            -e SANDBOX_RUNTIME_CONTAINER_IMAGE="docker.all-hands.dev/all-hands-ai/runtime:0.13-nikolaik" \
            -e SANDBOX_VOLUMES="oh-work:/workspace:rw" \
            -e LOG_ALL_EVENTS=true \
            -e LLM_CACHING_PROMPT=false \
            -e LLM_MODEL="gemini/gemini-2.5-flash" \
            -e LLM_API_KEY="$LLM_API_KEY" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --add-host host.docker.internal:host-gateway \
            --name openhands-test \
            docker.all-hands.dev/all-hands-ai/openhands:0.13 \
            python -m openhands.core.main -t "Pesquise na internet todas as provas, fases, versões, dias, e etc da $QUERY e devolva links diretos, para download ou para visualização direta, dos pdfs delas, caso haja bloqueio por captcha no google ou em algum provedor, tente o link direto ou trocar o motor de pesquisa"

      - name: Extract output
        run: |
          mkdir -p out
          docker run --rm \
            -v oh-work:/data \
            -v "$PWD/out":/out \
            alpine sh -lc 'ls -la /data && cp /data/hello_maia.txt /out/ 2>/dev/null || echo "File not found"'

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: search-result
          path: out/hello_maia.txt
